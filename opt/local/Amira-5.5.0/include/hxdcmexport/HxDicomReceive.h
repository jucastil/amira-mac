/*


COPYRIGHT

Unless otherwise specified, the DCMTK software package has the
following copyright:

/*
 *  Copyright (C) 1994-2004, OFFIS
 *
 *  This software and supporting documentation were developed by
 *
 *    Kuratorium OFFIS e.V.
 *    Healthcare Information and Communication Systems
 *    Escherweg 2
 *    D-26121 Oldenburg, Germany
 *
 *  THIS SOFTWARE IS MADE AVAILABLE,  AS IS,  AND OFFIS MAKES NO  WARRANTY
 *  REGARDING  THE  SOFTWARE,  ITS  PERFORMANCE,  ITS  MERCHANTABILITY  OR
 *  FITNESS FOR ANY PARTICULAR USE, FREEDOM FROM ANY COMPUTER DISEASES  OR
 *  ITS CONFORMITY TO ANY SPECIFICATION. THE ENTIRE RISK AS TO QUALITY AND
 *  PERFORMANCE OF THE SOFTWARE IS WITH THE USER.
 *
 *  Copyright of the software  and  supporting  documentation  is,  unless
 *  otherwise stated, owned by OFFIS, and free access is hereby granted as
 *  a license to  use  this  software,  copy  this  software  and  prepare
 *  derivative works based upon this software.  However, any  distribution
 *  of this software source code or supporting documentation or derivative
 *  works  (source code and  supporting documentation)  must  include  the
 *  three paragraphs of this copyright notice.
 *
 */

Some portions of the DCMTK software package are derived from earlier
versions of this software with the following copyright, and can be
identifed by the following copyright notice located in each source file:

/*  
 *  Copyright (C) 1993/1994, OFFIS, Oldenburg University and CERIUM
 *  
 *  This software and supporting documentation were
 *  developed by
 *  
 *    Institut OFFIS
 *    Bereich Kommunikationssysteme
 *    Westerstr. 10-12
 *    26121 Oldenburg, Germany
 *  
 *    Fachbereich Informatik
 *    Abteilung Prozessinformatik
 *    Carl von Ossietzky Universitaet Oldenburg
 *    Ammerlaender Heerstr. 114-118
 *    26111 Oldenburg, Germany
 *  
 *    CERIUM
 *    Laboratoire SIM
 *    Faculte de Medecine
 *    2 Avenue du Pr. Leon Bernard
 *    35043 Rennes Cedex, France
 *  
 *  for CEN/TC251/WG4 as a contribution to the Radiological
 *  Society of North America (RSNA) 1993 Digital Imaging and
 *  Communications in Medicine (DICOM) Demonstration.
 *  
 *  THIS SOFTWARE IS MADE AVAILABLE, AS IS, AND NEITHER OFFIS,
 *  OLDENBURG UNIVERSITY NOR CERIUM MAKE ANY WARRANTY REGARDING
 *  THE SOFTWARE, ITS PERFORMANCE, ITS MERCHANTABILITY OR
 *  FITNESS FOR ANY PARTICULAR USE, FREEDOM FROM ANY COMPUTER
 *  DISEASES OR ITS CONFORMITY TO ANY SPECIFICATION.  THE
 *  ENTIRE RISK AS TO QUALITY AND PERFORMANCE OF THE SOFTWARE
 *  IS WITH THE USER.
 *  
 *  Copyright of the software and supporting documentation
 *  is, unless otherwise stated, jointly owned by OFFIS,
 *  Oldenburg University and CERIUM and free access is hereby
 *  granted as a license to use this software, copy this
 *  software and prepare derivative works based upon this
 *  software. However, any distribution of this software
 *  source code or supporting documentation or derivative
 *  works (source code and supporting documentation) must
 *  include the three paragraphs of this copyright notice.
 *  
 */ 

Some other parts of this software within the dcmtk/dcmnet
sub-package related to the DICOM Upper Layer Protocol are
derived from software developed for the RSNA'93 DICOM
demonstration and kindly made available to us by the Mallinckrodt
Institute of Radiology.  Such software can be identifed by the
following copyright notice located in each affected source file:

/*
 *  Copyright (C) 1993, RSNA and Washington University
 *
 *  The software and supporting documentation for the Radiological
 *  Society of North America (RSNA) 1993 Digital Imaging and
 *  Communications in Medicine (DICOM) Demonstration were developed
 *  at the
 *          Electronic Radiology Laboratory
 *          Mallinckrodt Institute of Radiology
 *          Washington University School of Medicine
 *          510 S. Kingshighway Blvd.
 *          St. Louis, MO 63110
 *  as part of the 1993 DICOM Central Test Node project for, and
 *  under contract with, the Radiological Society of North America.
 *
 *  THIS SOFTWARE IS MADE AVAILABLE, AS IS, AND NEITHER RSNA NOR
 *  WASHINGTON UNIVERSITY MAKE ANY WARRANTY ABOUT THE SOFTWARE, ITS
 *  PERFORMANCE, ITS MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR
 *  USE, FREEDOM FROM ANY COMPUTER DISEASES OR ITS CONFORMITY TO ANY
 *  SPECIFICATION. THE ENTIRE RISK AS TO QUALITY AND PERFORMANCE OF
 *  THE SOFTWARE IS WITH THE USER.
 *
 *  Copyright of the software and supporting documentation is
 *  jointly owned by RSNA and Washington University, and free access
 *  is hereby granted as a license to use this software, copy this
 *  software and prepare derivative works based upon this software.
 *  However, any distribution of this software source code or
 *  supporting documentation or derivative works (source code and
 *  supporting documentation) must include the three paragraphs of
 *  the copyright notice.
 */

The dcmjpeg sub-package includes an adapted version of the Independent JPEG
Group Toolkit Version 6b, which is contained in dcmjpeg/libijg8,
dcmjpeg/libijg12 and dcmjpeg/libijg16.  This toolkit is covered by the
following copyright.  The original README file for the Independent JPEG
Group Toolkit is located in dcmjpeg/docs/ijg_readme.txt.

/*
 *  The authors make NO WARRANTY or representation, either express or implied,
 *  with respect to this software, its quality, accuracy, merchantability, or
 *  fitness for a particular purpose.  This software is provided "AS IS", and you,
 *  its user, assume the entire risk as to its quality and accuracy.
 *
 *  This software is copyright (C) 1991-1998, Thomas G. Lane.
 *  All Rights Reserved except as specified below.
 *
 *  Permission is hereby granted to use, copy, modify, and distribute this
 *  software (or portions thereof) for any purpose, without fee, subject to these
 *  conditions:
 *  (1) If any part of the source code for this software is distributed, then this
 *  README file must be included, with this copyright and no-warranty notice
 *  unaltered; and any additions, deletions, or changes to the original files
 *  must be clearly indicated in accompanying documentation.
 *  (2) If only executable code is distributed, then the accompanying
 *  documentation must state that "this software is based in part on the work of
 *  the Independent JPEG Group".
 *  (3) Permission for use of this software is granted only if the user accepts
 *  full responsibility for any undesirable consequences; the authors accept
 *  NO LIABILITY for damages of any kind.
 *
 *  These conditions apply to any software derived from or based on the IJG code,
 *  not just to the unmodified library.  If you use our work, you ought to
 *  acknowledge us.
 *
 *  Permission is NOT granted for the use of any IJG author's name or company name
 *  in advertising or publicity relating to this software or products derived from
 *  it.  This software may be referred to only as "the Independent JPEG Group's
 *  software".
 *
 *  We specifically permit and encourage the use of this software as the basis of
 *  commercial products, provided that all warranty or liability claims are
 *  assumed by the product vendor.
 */


The color quantization code in module dcmimage (dcmquant and the related
classes) is derived from code written by Jef Poskanzer for the NetPBM
toolkit which has the following copyright:

/*
 * Copyright (C) 1989, 1991 by Jef Poskanzer.
 *
 * Permission to use, copy, modify, and distribute this software and its
 * documentation for any purpose and without fee is hereby granted, provided
 * that the above copyright notice appear in all copies and that both that
 * copyright notice and this permission notice appear in supporting
 * documentation.  This software is provided "as is" without express or
 * implied warranty.
 */


The code for the OFStandard::strlcpy and OFStandard::strlcat helper
functions in ofstd/libsrc/ofstd.cc has been derived from the BSD
implementation of strlcpy() and strlcat() and which carries the
following copyright notice:

/*
 *  Copyright (c) 1998 Todd C. Miller <Todd.Miller(at)courtesan.com>
 *  All rights reserved.
 *
 *  Redistribution and use in source and binary forms, with or without
 *  modification, are permitted provided that the following conditions
 *  are met:
 *  1. Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 *  2. Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 *  3. The name of the author may not be used to endorse or promote products
 *     derived from this software without specific prior written permission.
 *
 *  THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,
 *  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
 *  AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 *  THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 *  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 *  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 *  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 *  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */


The code for the OFStandard::atof helper function in
ofstd/libsrc/ofstd.cc has been derived from an implementation which
carries the following copyright notice:

/*
 *  Copyright 1988 Regents of the University of California
 *  Permission to use, copy, modify, and distribute this software and
 *  its documentation for any purpose and without fee is hereby granted,
 *  provided that the above copyright notice appear in all copies.  The
 *  University of California makes no representations about the
 *  suitability of this software for any purpose.  It is provided "as
 *  is" without express or implied warranty.
 *
 *
 *  The code for OFStandard::ftoa has been derived
 *  from an implementation which carries the following copyright notice:
 *
 *  Copyright (c) 1988 Regents of the University of California.
 *  All rights reserved.
 *
 *  Redistribution and use in source and binary forms are permitted
 *  provided that the above copyright notice and this paragraph are
 *  duplicated in all such forms and that any documentation,
 *  advertising materials, and other materials related to such
 *  distribution and use acknowledge that the software was developed
 *  by the University of California, Berkeley.  The name of the
 *  University may not be used to endorse or promote products derived
 *  from this software without specific prior written permission.
 *  THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 *  IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 *  WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 */

The "Base64" encoder/decoder in ofstd/libsrc/ofstd.cc has been derived
from an implementation which carries the following copyright notice:

/*
 *  Copyright (c) 1999, Bob Withers - bwit(at)pobox.com
 *
 *  This code may be freely used for any purpose, either personal or commercial,
 *  provided the authors copyright notice remains intact.
 */

The dcmjp2k sub-package (which is currently not part of the free 
toolkit) includes an adapted version of the JasPer JPEG 2000 toolkit, 
which is contained in dcmjp2k/libjaspr. This toolkit is covered by 
the following copyright.

/*  JasPer License Version 2.0
 *  
 *  Copyright (c) 1999-2000 Image Power, Inc.
 *  Copyright (c) 1999-2000 The University of British Columbia
 *  Copyright (c) 2001-2003 Michael David Adams
 *  
 *  All rights reserved.
 *  
 *  Permission is hereby granted, free of charge, to any person (the
 *  "User") obtaining a copy of this software and associated documentation
 *  files (the "Software"), to deal in the Software without restriction,
 *  including without limitation the rights to use, copy, modify, merge,
 *  publish, distribute, and/or sell copies of the Software, and to permit
 *  persons to whom the Software is furnished to do so, subject to the
 *  following conditions:
 *  
 *  1.  The above copyright notices and this permission notice (which
 *  includes the disclaimer below) shall be included in all copies or
 *  substantial portions of the Software.
 *  
 *  2.  The name of a copyright holder shall not be used to endorse or
 *  promote products derived from the Software without specific prior
 *  written permission.
 *  
 *  THIS DISCLAIMER OF WARRANTY CONSTITUTES AN ESSENTIAL PART OF THIS
 *  LICENSE.  NO USE OF THE SOFTWARE IS AUTHORIZED HEREUNDER EXCEPT UNDER
 *  THIS DISCLAIMER.  THE SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS
 *  "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
 *  BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 *  PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.  IN NO
 *  EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
 *  INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
 *  FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
 *  NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
 *  WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  NO ASSURANCES ARE
 *  PROVIDED BY THE COPYRIGHT HOLDERS THAT THE SOFTWARE DOES NOT INFRINGE
 *  THE PATENT OR OTHER INTELLECTUAL PROPERTY RIGHTS OF ANY OTHER ENTITY.
 *  EACH COPYRIGHT HOLDER DISCLAIMS ANY LIABILITY TO THE USER FOR CLAIMS
 *  BROUGHT BY ANY OTHER ENTITY BASED ON INFRINGEMENT OF INTELLECTUAL
 *  PROPERTY RIGHTS OR OTHERWISE.  AS A CONDITION TO EXERCISING THE RIGHTS
 *  GRANTED HEREUNDER, EACH USER HEREBY ASSUMES SOLE RESPONSIBILITY TO SECURE
 *  ANY OTHER INTELLECTUAL PROPERTY RIGHTS NEEDED, IF ANY.  THE SOFTWARE
 *  IS NOT FAULT-TOLERANT AND IS NOT INTENDED FOR USE IN MISSION-CRITICAL
 *  SYSTEMS, SUCH AS THOSE USED IN THE OPERATION OF NUCLEAR FACILITIES,
 *  AIRCRAFT NAVIGATION OR COMMUNICATION SYSTEMS, AIR TRAFFIC CONTROL
 *  SYSTEMS, DIRECT LIFE SUPPORT MACHINES, OR WEAPONS SYSTEMS, IN WHICH
 *  THE FAILURE OF THE SOFTWARE OR SYSTEM COULD LEAD DIRECTLY TO DEATH,
 *  PERSONAL INJURY, OR SEVERE PHYSICAL OR ENVIRONMENTAL DAMAGE ("HIGH
 *  RISK ACTIVITIES").  THE COPYRIGHT HOLDERS SPECIFICALLY DISCLAIM ANY
 *  EXPRESS OR IMPLIED WARRANTY OF FITNESS FOR HIGH RISK ACTIVITIES.
 */ 

*/

/// @addtogroup hxdcmexport hxdcmexport
/// @{
#ifndef HX_DICOM_RECEIVE_H
#define HX_DICOM_RECEIVE_H


/* 
This class encapsulate in a module the dcmtk storescp command

This command can be launched in a thread if setThreadMode(true) is called.
The virtual methods executeOnReception() and executeOnEndOfStudy() are executed in the thread
The virtual method checkEndOfStudy() is registered with a timeout in order to be executed in the main thread.
The timeout is registered with the method registerCheckEndOfStudy()
Beware, Amira is not multithread and using HxDicomReceive in multi thread mode can be dangerous

If no thread is used, checkEndOfStudy() will be called just after executeOnEndOfStudy()

*/
#include <hxdcmexport/hxdcmexportAPI.h>

#include <hxcore/HxModule.h>
#include <hxcore/HxPortIntSlider.h> 
#include <hxcore/HxPortText.h> 
#include <hxcore/HxPortIntTextN.h> 

#include <dcmtk/ofstd/oftypes.h>
#include <dcmtk/ofstd/ofcmdln.h>
#include <dcmtk/dcmdata/dcxfer.h>
#include <dcmtk/dcmnet/assoc.h>
#include <dcmtk/dcmnet/dimse.h> 

class DcmFileFormat;
class DcmAssociationConfiguration;

#include <QThread>

class HXDCMEXPORT_API HxDicomReceive : public HxModule, public QThread
{

    HX_HEADER( HxDicomReceive );

public:

    /// Constructor
    HxDicomReceive( );

    /// Destructor
    ~HxDicomReceive();

    // Timeout for end of study detection
    HxPortIntTextN m_portTimeOut;

    // Connexion port
    HxPortIntSlider m_connexionPort;

    // Application entity
    HxPortText m_applicationEntity;

    //set multi thread mode
    void setThreadMode( bool threadMode ){ m_threadMode = threadMode; }

    // In multithread mode, register a timeout in the main thread that check the end of study
    void registerCheckEndOfStudy();

    virtual void update(){}

    virtual void compute();

    //Output directory
    static void setOutputDir( McString outputdir );

    virtual void executeOnReception();

    virtual void executeOnEndOfStudy();

    //Timeout function called by the main thread
    virtual void checkEndOfStudy(){}

protected:

    // init the arguments 
    void fillArguments();

    //thread routine in xthread mode
    void run();

    //temp command arguments
    int m_argc;

    char* m_argv[1024];

    //set to true if running storescp
    bool m_launched;

    //xthread mode
    bool m_threadMode;

public:
    // ---------- storescp encapsulation-----------------------------------------------------------------------

    struct StoreCallbackData
    {
        char* imageFileName;
        DcmFileFormat* dcmff;
        T_ASC_Association* assoc;
    };

    static 
        void storeSCPCallback( void *callbackData,
        T_DIMSE_StoreProgress *progress,
        T_DIMSE_C_StoreRQ *req,
        char * /*imageFileName*/, DcmDataset **imageDataSet,
        T_DIMSE_C_StoreRSP *rsp,
        DcmDataset **statusDetail);

    OFCondition processCommands(T_ASC_Association *assoc);
    OFCondition acceptAssociation(T_ASC_Network *net, DcmAssociationConfiguration& asccfg);
    OFCondition echoSCP(T_ASC_Association * assoc, T_DIMSE_Message * msg, T_ASC_PresentationContextID presID);
    OFCondition storeSCP(T_ASC_Association * assoc, T_DIMSE_Message * msg, T_ASC_PresentationContextID presID);
    void executeEndOfStudyEvents();
    void renameOnEndOfStudy();
    void executeCommand( const OFString &cmd );
    void cleanChildren(pid_t pid, OFBool synch);
    static int makeTempFile();

    /// main function replaced
    int storescp(int argc, char* argv[]);
    // -------------------------------------------------------------------------------------------------------

protected:

    static McString m_outputDir;

    static void checkOutputDir();

    static OFBool             opt_uniqueFilenames;
    static OFString           opt_fileNameExtension;
    static OFBool             opt_timeNames;
    static int            timeNameCounter;
    static OFCmdUnsignedInt   opt_port;
    static OFBool             opt_refuseAssociation;
    static OFBool             opt_rejectWithoutImplementationUID;
    static OFCmdUnsignedInt   opt_sleepAfter;
    static OFCmdUnsignedInt   opt_sleepDuring;
    static OFCmdUnsignedInt   opt_maxPDU;
    static OFBool             opt_useMetaheader;
    static E_TransferSyntax   opt_networkTransferSyntax;
    static E_TransferSyntax   opt_writeTransferSyntax;
    static E_GrpLenEncoding   opt_groupLength;
    static E_EncodingType     opt_sequenceType;
    static E_PaddingEncoding  opt_paddingType;
    static OFCmdUnsignedInt   opt_filepad;
    static OFCmdUnsignedInt   opt_itempad;
    static OFCmdUnsignedInt   opt_compressionLevel;
    static OFBool             opt_verbose;
    static OFBool             opt_debug;
    static OFBool             opt_bitPreserving;
    static OFBool             opt_ignore;
    static OFBool             opt_abortDuringStore;
    static OFBool             opt_abortAfterStore;
    static OFBool             opt_promiscuous;
    static OFBool             opt_correctUIDPadding;
    static OFBool             opt_inetd_mode;
    static OFString           callingaetitle;  
    static OFString           calledaetitle;   
    static const char *       opt_respondingaetitle;

    static OFBool      opt_secureConnection;
    static OFString    opt_outputDirectory;          
    static const char *opt_sortConcerningStudies;
    static const char *opt_execOnReception;
    static const char *opt_execOnEndOfStudy;

    static OFBool      opt_renameOnEndOfStudy;
    static long        opt_endOfStudyTimeout;
    static OFBool      endOfStudyThroughTimeoutEvent;
    static const char *opt_configFile;
    static const char *opt_profileName;

    static OFString           lastStudyInstanceUID;
    static OFString           subdirectoryPathAndName;
    static OFList<OFString>   outputFileNameArray;
    static OFString           lastStudySubdirectoryPathAndName;
    static T_DIMSE_BlockingMode opt_blockMode;
    static int                opt_dimse_timeout;
    static int                opt_acse_timeout;
};

#endif //HX_DICOM_RECEIVE_H

/// @}
